const fp = require('fastify-plugin')
const createTunnelProcessManager = require('../tunnel-process-manager')

module.exports = fp(initPlugin)

async function initPlugin(fastify, opts) {
  const {
    env: {tunnelConfigFileDirectory, runTunnelBinPath, logFileDirectory, socks5Proxies, portRange},
  } = opts

  const tunnelProcessManager = createTunnelProcessManager({
    logFileDirectory,
    tunnelConfigFileDirectory,
    runTunnelBinPath,
    socks5Proxies,
    portRange,
  })

  fastify.decorate('tunnelProcessManager', tunnelProcessManager)
}
