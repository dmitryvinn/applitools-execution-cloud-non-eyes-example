"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeEndSession = void 0;
function makeEndSession({ req, tunnels }) {
    return async function endSession({ session, request, response, logger, }) {
        var _a, _b;
        var _c;
        logger.log(`Request was intercepted with sessionId:`, session.sessionId);
        await req(request.url, { io: { request, response }, logger });
        if ((_a = session.tests) === null || _a === void 0 ? void 0 : _a.current) {
            await session.tests.current.abort({ settings: { testMetadata: session.metadata }, logger });
            (_b = (_c = session.tests).ended) !== null && _b !== void 0 ? _b : (_c.ended = []);
            session.tests.ended.push(session.tests.current);
            session.tests.current = undefined;
        }
        if (session.tunnels && tunnels) {
            await tunnels.release(session.tunnels);
            logger.log(`Tunnels with id ${session.tunnels.map(tunnel => tunnel.tunnelId)} was released for session with id ${session.sessionId}`);
        }
    };
}
exports.makeEndSession = makeEndSession;
