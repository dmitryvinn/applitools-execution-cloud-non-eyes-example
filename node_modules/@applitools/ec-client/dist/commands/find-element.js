"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeFindElement = void 0;
function makeFindElement({ req }) {
    return async function findElement({ session, request, response, logger, }) {
        var _a, _b, _c;
        logger.log('Inspecting element lookup request to collect self-healing metadata');
        const proxyResponse = await req(request.url, { io: { request, response, handle: false }, logger });
        const responseBody = Buffer.from(await proxyResponse.arrayBuffer());
        const parsed = JSON.parse(responseBody.toString('utf8'));
        if ((_b = (_a = parsed === null || parsed === void 0 ? void 0 : parsed.appliCustomData) === null || _a === void 0 ? void 0 : _a.selfHealing) === null || _b === void 0 ? void 0 : _b.successfulSelector) {
            logger.log('Self-healed locators detected', parsed.appliCustomData.selfHealing);
            (_c = session.metadata) !== null && _c !== void 0 ? _c : (session.metadata = []);
            session.metadata.push(parsed.appliCustomData.selfHealing);
        }
        else {
            logger.log('No self-healing metadata found');
        }
        response.writeHead(proxyResponse.status, Object.fromEntries(proxyResponse.headers.entries())).end(responseBody);
    };
}
exports.makeFindElement = makeFindElement;
